name: Test Jekyll site build

on:  
  # Runs on all pull requests
  pull_request:

# No deployment permissions needed for testing
permissions:
  contents: read

jobs:
  # Build and test job
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Build with Jekyll (preinstalled dependencies)
        uses: actions/jekyll-build-pages@v1
        with:
          source: ./jekyll-site
          destination: ./jekyll-site/_site
        env:
          JEKYLL_ENV: development

      - name: Upload test artifact (built site)
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./jekyll-site/_site

      - name: Check internal links with lychee
        uses: lycheeverse/lychee-action@v1
        with:
          # point lychee at the built site
          path: ./jekyll-site/_site
          # fail the job on broken links
          fail-on-error: true

      - name: Setup Node (for validators)
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Validate HTML with html-validate
        run: |
          set -euo pipefail
          # Install a lightweight validator without committing package files
          npm init -y >/dev/null
          npm i --no-save html-validate --silent
          echo "Running html-validate on built site..."
          npx html-validate -f text "jekyll-site/_site/**/*.html"



      - name: Install puppeteer and capture screenshots
        run: |
          set -euo pipefail
          npm init -y >/dev/null
          npm i puppeteer --no-audit --no-fund --silent
          node .github/scripts/screenshot.js

      - name: Upload screenshots
        uses: actions/upload-artifact@v4
        with:
          name: site-screenshots
          path: screenshots/
      
      - name: Comment PR with screenshots
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          script: |
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const comment = `## üì∏ Site Screenshots\n\nScreenshots of the built site are available in the [Actions run artifacts](${runUrl}).\n\nYou can download them from the "site-screenshots" artifact in the run summary.`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
      
      - name: Test build output
        run: |
          echo "‚úÖ Jekyll site built successfully"
          echo "üìÅ Build output directory:"
          ls -la ./jekyll-site/_site
          echo ""
          echo "üìÑ Generated files:"
          find ./jekyll-site/_site -type f | head -20
      
      - name: Check for broken links (optional)
        working-directory: ./jekyll-site/_site
        run: |
          set -euo pipefail
          echo "üîç Checking built HTML pages and basic SEO/structure"

          PAGES=("index.html" "about/index.html" "retreat/index.html" "kontakt/index.html")

          for p in "${PAGES[@]}"; do
            echo "\n-- checking $p --"
            if [ ! -f "$p" ]; then
              echo "‚ùå $p not found"
              exit 1
            fi

            # DOCTYPE
            if ! head -n 2 "$p" | tr '[:upper:]' '[:lower:]' | grep -q "<!doctype html"; then
              echo "‚ùå $p missing <!doctype html>"
              exit 1
            else
              echo "‚úÖ DOCTYPE present"
            fi

            # html lang attribute (expect de)
            if ! grep -qi '<html[^>]*lang="de"' "$p"; then
              echo "‚ö†Ô∏è  $p: html lang attribute not set to \"de\" (recommended)"
            else
              echo "‚úÖ html lang=de present"
            fi

            # title exists and non-empty
            title=$(sed -n 's/.*<title>\(.*\)<\/title>.*/\1/p' "$p" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//') || true
            if [ -z "$title" ]; then
              echo "‚ùå $p: <title> is missing or empty"
              exit 1
            else
              echo "‚úÖ title: $title"
            fi

            # meta description
            if ! grep -qi '<meta[^>]*name=["\'']description["\'']' "$p"; then
              echo "‚ùå $p: meta description missing"
              exit 1
            else
              echo "‚úÖ meta description present"
            fi
          done

          echo "\n-- navigation checks (index.html) --"
          NAV_MISS=0
          for target in '/about/' '/retreat/' '/kontakt/'; do
            if ! grep -q "$target" index.html; then
              echo "‚ùå index.html missing nav link to $target"
              NAV_MISS=1
            else
              echo "‚úÖ nav contains $target"
            fi
          done
          if [ "$NAV_MISS" -eq 1 ]; then
            exit 1
          fi

          echo "\n-- assets checks --"
          # Ensure images folder exists and not empty
          if [ -d "assets/images" ] && [ "$(ls -A assets/images | wc -l)" -gt 0 ]; then
            echo "‚úÖ assets/images contains files"
          else
            echo "‚ö†Ô∏è  assets/images appears empty or missing (check image usage)"
          fi

          # Check contact email exists on kontakt page or index
          if grep -qi 'mailto:a_heinicke@web.de' kontakt/index.html || grep -qi 'mailto:a_heinicke@web.de' index.html; then
            echo "‚úÖ contact email found"
          else
            echo "‚ö†Ô∏è  contact email not found in built pages"
          fi

          echo "\n‚úÖ All quick HTML checks passed (or warnings printed)."
